# 微信公众号适配型 Markdown 渲染组件 - 技术架构设计文档

## 1. 技术栈选择

### 1.1 核心框架
- **React 18+**: 用于构建用户界面组件
- **Vite**: 构建工具，提供快速的开发体验和优化的生产构建
- **TypeScript**: 提供类型安全，增强代码可维护性

### 1.2 核心依赖库
- **markdown-it**: Markdown 解析引擎，支持插件扩展
- **highlight.js**: 代码语法高亮
- **juice**: CSS 内联化工具，将 CSS 样式转换为内联样式
- **classnames**: 动态类名管理
- **react-icons**: 图标库，提供丰富的图标资源

### 1.3 开发工具
- **ESLint**: 代码质量检查
- **Prettier**: 代码格式化
- **Jest**: 单元测试框架
- **@testing-library/react**: React 组件测试工具
- **npm**: 包管理器，统一使用 npm 管理依赖，不使用其他包管理器

## 2. 项目目录结构

```
md-wx-renderer/
├── src/
│   ├── components/          # React 组件
│   │   ├── Preview/         # 预览组件
│   │   │   ├── Preview.tsx
│   │   │   ├── Preview.css
│   │   │   └── index.ts
│   │   ├── SettingsBar/     # 设置按钮组件
│   │   │   ├── SettingsBar.tsx
│   │   │   ├── SettingsBar.css
│   │   │   └── index.ts
│   │   ├── ThemeSelector/   # 主题选择器
│   │   │   ├── ThemeSelector.tsx
│   │   │   ├── ThemeSelector.css
│   │   │   └── index.ts
│   │   ├── ViewToggle/      # 视图切换器
│   │   │   ├── ViewToggle.tsx
│   │   │   ├── ViewToggle.css
│   │   │   └── index.ts
│   │   ├── CopyButton/      # 复制按钮
│   │   │   ├── CopyButton.tsx
│   │   │   ├── CopyButton.css
│   │   │   └── index.ts
│   │   └── index.ts         # 组件导出
│   ├── themes/              # 主题样式
│   │   ├── theme1.css       # 微信官方默认主题
│   │   ├── theme2.css       # 简约白主题
│   │   ├── theme3.css       # 雅致灰主题
│   │   ├── theme4.css       # 文艺蓝主题
│   │   ├── theme5.css       # 复古棕主题
│   │   └── index.ts         # 主题配置
│   ├── utils/               # 工具函数
│   │   ├── markdown.ts      # Markdown 处理
│   │   ├── cssInliner.ts    # CSS 内联化
│   │   ├── htmlSanitizer.ts # HTML 清理
│   │   ├── wechatCompat.ts  # 微信公众号兼容性
│   │   └── clipboard.ts     # 剪贴板操作
│   ├── hooks/               # 自定义 Hook
│   │   ├── useMarkdown.ts
│   │   ├── useTheme.ts
│   │   └── useViewMode.ts
│   ├── types/               # TypeScript 类型定义
│   │   ├── index.ts
│   │   ├── theme.ts
│   │   └── component.ts
│   ├── constants/           # 常量定义
│   │   ├── themes.ts
│   │   └── config.ts
│   ├── index.ts             # 组件主入口
│   └──MdWxRenderer.tsx      # 主组件
├── docs/                    # 文档
├── tests/                   # 测试文件
├── examples/                # 使用示例
├── build/                   # 构建输出
├── package.json
├── tsconfig.json
├── vite.config.ts
├── .eslintrc.js
├── .prettierrc
└── README.md
```

## 3. 核心组件设计

### 3.1 MdWxRenderer 主组件
```typescript
interface MdWxRendererProps {
  content: string;              // Markdown 内容
  theme?: string;               // 主题名称
  defaultTheme?: string;        // 默认主题
  showSettingsBar?: boolean;    // 是否显示设置按钮
  defaultViewMode?: 'mobile' | 'desktop'; // 默认视图模式
  customSettingsBar?: React.ReactNode; // 自定义设置按钮
  onThemeChange?: (theme: string) => void; // 主题切换回调
  onViewModeChange?: (mode: 'mobile' | 'desktop') => void; // 视图切换回调
}
```

### 3.2 Preview 预览组件
- 接收 Markdown 内容并实时渲染
- 根据当前主题应用对应样式
- 支持手机/桌面视图自适应
- 提供滚动区域，设置按钮固定在顶部

### 3.3 SettingsBar 设置按钮组件
- 主题切换按钮
- 视图模式切换按钮
- 复制按钮
- 设置按钮居中对齐，固定在预览区域顶部

## 4. 核心技术方案

### 4.1 微信公众号兼容性处理

#### 4.1.1 HTML 标签适配
- 实现思路：针对微信公众号不支持的 HTML 标签，建立标签映射规则，将不支持的标签转换为支持的标签
- 技术方案：使用标签映射器对解析后的 HTML 进行遍历处理，将 div、span 等不支持标签转换为 section、p 等支持标签

#### 4.1.2 CSS 内联化处理
- 实现思路：将外部 CSS 样式转换为内联样式，确保微信公众号编辑器能正确识别样式
- 技术方案：使用 juice 库将 CSS 规则转换为内联样式，支持自定义配置选项

#### 4.1.3 样式兼容性检查
- 实现思路：建立微信公众号支持的 CSS 属性白名单，过滤掉不支持的样式属性
- 技术方案：遍历 HTML 元素的内联样式，只保留白名单中的 CSS 属性

### 4.2 主题系统设计

#### 4.2.1 主题配置结构
- 实现思路：设计统一的主题配置结构，包含主题名称、显示名称、样式文件路径和主题变量
- 技术方案：每个主题通过配置文件定义，支持动态切换和扩展

#### 4.2.2 5 个预设主题设计
1. **微信官方默认主题**: 模拟公众号原生排版样式，保持与微信编辑器默认效果一致
2. **简约白主题**: 纯白背景，清晰字体，适合技术类、干货类内容
3. **雅致灰主题**: 低饱和度灰色背景，护眼舒适，适合长文阅读场景
4. **文艺蓝主题**: 柔和蓝色调点缀，风格清新，适合情感类、生活类内容
5. **复古棕主题**: 暖棕色系配色，复古质感，适合文化类、历史类内容

### 4.3 代码块样式设计
- 实现思路：为代码块添加 Mac 风格的窗口装饰元素，包含关闭/最小化/最大化图标
- 技术方案：默认使用 github-dark 风格的代码高亮，支持自定义代码块样式

### 4.4 响应式设计方案
- 实现思路：支持手机和桌面两种视图模式，默认显示手机视图
- 技术方案：根据视图模式动态调整预览区域的最大宽度、字体大小和内边距，实现响应式布局

## 5. 编码规范

### 5.1 文件命名规范
- 组件文件使用 PascalCase：`MdWxRenderer.tsx`
- 工具函数文件使用 camelCase：`markdownParser.ts`
- CSS 文件使用 kebab-case：`preview-component.css`
- 常量文件使用 UPPER_SNAKE_CASE：`THEME_CONSTANTS.ts`

### 5.2 目录结构规范
- 每个组件目录包含：`{ComponentName}.tsx`、`{ComponentName}.css`、`index.ts`
- 相关功能文件放置在同一目录下
- 公共工具函数放置在 `utils/` 目录
- 类型定义统一放置在 `types/` 目录

### 5.3 代码规范
- 使用 TypeScript 严格模式
- 组件必须使用函数式组件和 Hooks
- 所有组件必须导出类型定义
- 使用 Prettier 统一代码格式
- 使用 ESLint 检查代码质量

### 5.4 注释规范
- 所有公共 API 必须有 JSDoc 注释
- 复杂的业务逻辑需要添加行内注释
- 微信兼容性相关的代码需要详细说明

## 6. 关键算法设计

### 6.1 Markdown 到微信公众号 HTML 转换流程
- 实现思路：将 Markdown 文本转换为符合微信公众号规范的 HTML
- 技术方案：
  1. 解析 Markdown 文本生成基础 HTML
  2. 清理和适配 HTML，确保符合微信公众号规范
  3. 替换不支持的 HTML 标签
  4. 应用当前主题样式
  5. 将 CSS 样式内联到 HTML 元素中

### 6.2 复制内容处理算法
- 实现思路：将预览区域内容转换为微信公众号支持的格式并复制到剪贴板
- 技术方案：
  1. 获取预览区域的 HTML 内容
  2. 进行微信公众号兼容性处理
  3. 转换为符合剪贴板 API 要求的数据格式
  4. 使用剪贴板 API 将数据写入剪贴板

## 7. 性能优化方案

### 7.1 渲染性能优化
- 使用 React.memo 缓存纯组件
- 使用 useMemo 缓存计算结果
- 使用 useCallback 缓存事件处理函数
- 虚拟滚动处理大量内容

### 7.2 打包优化
- 使用 Vite 的代码分割
- 主题样式按需加载
- 第三方库使用 CDN 引入
- 生产环境去除 console.log

## 8. 测试策略

### 8.1 单元测试
- 工具函数测试（markdown 解析、CSS 内联化等）
- 组件渲染测试
- 主题切换功能测试
- 复制功能测试

### 8.2 集成测试
- 完整渲染流程测试
- 微信公众号兼容性测试
- 响应式布局测试
- 性能测试

### 8.3 E2E 测试
- 端到端用户操作测试
- 跨浏览器兼容性测试
- 移动端适配测试

## 9. 部署方案

### 9.1 NPM 包发布
- 使用 npm 进行包发布和管理
- 使用 semantic-release 自动发布
- 支持 ESModule 和 CommonJS
- 提供 TypeScript 类型定义
- 包含完整的文档和示例

### 9.2 版本管理
- 使用语义化版本控制
- 主版本：破坏性变更
- 次版本：向后兼容的功能性新增
- 修订号：向后兼容的问题修正

## 10. 风险控制

### 10.1 微信公众号兼容性风险
- 建立完整的兼容性测试用例
- 维护支持标签和属性的白名单
- 提供降级方案

### 10.2 性能风险
- 设置性能监控指标
- 实施代码分割和懒加载
- 优化大型依赖库

### 10.3 维护性风险
- 建立完善的文档体系
- 实施代码审查机制
- 维护单元测试覆盖率

## 11. 开发里程碑

### 11.1 第一阶段：核心功能（2周）
- 完成项目搭建和基础组件开发
- 实现 Markdown 解析和基本渲染
- 完成主题系统设计

### 11.2 第二阶段：微信兼容性（1周）
- 实现 CSS 内联化功能
- 完成微信公众号标签适配
- 实现复制功能

### 11.3 第三阶段：优化完善（1周）
- 性能优化和代码重构
- 完善测试用例
- 文档和示例编写

### 11.4 第四阶段：发布准备（0.5周）
- 打包和发布配置
- 兼容性验证
- 版本发布